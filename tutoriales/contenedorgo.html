
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.1, mkdocs-material-7.1.8">
    
    
      
        <title>Tutorial Go - CONTENEDORES</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.ca7ac06f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.f1a3b89f.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tutorial-ontenedor-en-go" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../index.html" title="CONTENEDORES" class="md-header__button md-logo" aria-label="CONTENEDORES" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CONTENEDORES
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Tutorial Go
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="CONTENEDORES" class="md-nav__button md-logo" aria-label="CONTENEDORES" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    CONTENEDORES
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        Aproximación a los contenedores
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Tutorial Go
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="contenedorgo.html" class="md-nav__link md-nav__link--active">
        Tutorial Go
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#paso-1-creacion-del-codigo-base" class="md-nav__link">
    Paso 1: Creación del código base
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#paso-2-aislando-con-namespace-uts-hostname" class="md-nav__link">
    Paso 2: Aislando con Namespace UTS (Hostname)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#paso-3-aislando-con-namespace-user-username" class="md-nav__link">
    Paso 3: Aislando con Namespace USER (username)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#paso-4-aislando-con-namespace-ns-mount" class="md-nav__link">
    Paso 4: Aislando con Namespace NS (Mount)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#paso-5-aislando-con-namespace-pid" class="md-nav__link">
    Paso 5: Aislando con Namespace PID
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#paso-6-anadiendo-un-filesystem-para-el-contenedor" class="md-nav__link">
    Paso 6: Añadiendo un Filesystem para el contenedor
  </a>
  
    <nav class="md-nav" aria-label="Paso 6: Añadiendo un Filesystem para el contenedor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#montamos-nuestro-propio-proc" class="md-nav__link">
    Montamos nuestro propio /proc
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#anadiendo-cgroups-memoria-y-pid" class="md-nav__link">
    Añadiendo Cgroups (memoria y PID)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#anexo-mejora-con-pivot_root" class="md-nav__link">
    Anexo: mejora con pivot_root
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="contenedorbash.html" class="md-nav__link">
        Tutorial Bash
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#paso-1-creacion-del-codigo-base" class="md-nav__link">
    Paso 1: Creación del código base
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#paso-2-aislando-con-namespace-uts-hostname" class="md-nav__link">
    Paso 2: Aislando con Namespace UTS (Hostname)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#paso-3-aislando-con-namespace-user-username" class="md-nav__link">
    Paso 3: Aislando con Namespace USER (username)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#paso-4-aislando-con-namespace-ns-mount" class="md-nav__link">
    Paso 4: Aislando con Namespace NS (Mount)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#paso-5-aislando-con-namespace-pid" class="md-nav__link">
    Paso 5: Aislando con Namespace PID
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#paso-6-anadiendo-un-filesystem-para-el-contenedor" class="md-nav__link">
    Paso 6: Añadiendo un Filesystem para el contenedor
  </a>
  
    <nav class="md-nav" aria-label="Paso 6: Añadiendo un Filesystem para el contenedor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#montamos-nuestro-propio-proc" class="md-nav__link">
    Montamos nuestro propio /proc
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#anadiendo-cgroups-memoria-y-pid" class="md-nav__link">
    Añadiendo Cgroups (memoria y PID)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#anexo-mejora-con-pivot_root" class="md-nav__link">
    Anexo: mejora con pivot_root
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="tutorial-ontenedor-en-go">Tutorial ontenedor en Go</h1>
<div class="admonition warning">
<p class="admonition-title">CUIDADO</p>
<p>Es muy recomendable utilizar una MV para realizar los siguientes pasos ya que pueden provocar problemas en el sistema si no se realizan correctamente.</p>
</div>
<p>Nuestro objetivo es que, al acabar este tutorial, tengamos un programa que sea capaz de crear un proceso y aislarlo con <em>namespaces</em> y <em>cgroups</em>. De hecho, intentaremos que la interacción con éste sea muy parecida a la que tendríamos cuando ejecutamos un contenedor Docker:</p>
<div class="highlight"><pre><span></span><code><span class="gp">    # </span>Nosotros vamos a ejecutarlo así:
<span class="gp">root@bar:~$ </span>go     run contenedor.go run         &lt;command&gt; &lt;args&gt;
<span class="gp">    # </span>Una ejecución en Docker sería algo de este estilo:
<span class="gp">root@bar:~$ </span>docker                   run &lt;image&gt; &lt;command&gt; &lt;args&gt;
</code></pre></div>
<div class="admonition info">
<p>Cabe destacar que es necesario que <strong>todos los ficheros estén en una carpeta cuyo grupo y usuario pertenezca a root</strong>, así como realizar todos los comandos con privilegios de root.</p>
</div>
<h2 id="paso-1-creacion-del-codigo-base">Paso 1: Creación del código base</h2>
<p>El primer paso consiste en <strong>escribir las primeras dos funciones</strong>: <code>main</code>, que simplemente comprobará que se ha ejecutado el comando correcto en terminal y <code>run</code>, que imprimirá en pantalla los datos del proceso y ejecutará otro nuevo que le indiquemos en parámetro.</p>
<div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;os&quot;</span>
    <span class="s">&quot;os/exec&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s">&quot;run&quot;</span><span class="p">:</span>
            <span class="nx">run</span><span class="p">()</span>
        <span class="k">default</span><span class="p">:</span>
            <span class="nb">panic</span><span class="p">(</span><span class="s">&quot;¿Argumento Invalido?&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">run</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Corriendo &#39;%v&#39; con User ID %d en PID %d \n&quot;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getuid</span><span class="p">(),</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">())</span>

    <span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nx">Command</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdin</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdout</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stderr</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Run</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<p>Ahora puedes probar a ejecutar la instrucción <code>go run contenedor.go run ps a</code> y comprobar que se existen dos procesos: el <strong>contenedor.go</strong> y el <strong>ps a</strong> que le hemos indicado que ejecute dentro del "pre-contenedor".</p>
<details class="info"><summary>Explicación</summary><p>La función <code>run</code> simplemente imprime por pantalla información útil sobre el proceso que estamos ejecutando y que, más adelante, creará el contenedor. De momento, lo único que estamos haciendo es indicarle que queremos ejecutar un comando con la función <code>Command</code> del paquete <a href="https://golang.org/pkg/os/exec/"><code>exec</code></a> indicándole los argumentos. Este comando devuelve una estructura del tipo <code>Cmd</code> en la que tenemos que especificarle el <em>Stdin</em> <em>Stdout</em> y <em>Stderr</em>.</p>
<p>También podemos ejecutar otros comandos dentro del contenedor, como <code>go run contenedor.go run /bin/bash</code>, en cuyo caso se abrirá una nueva terminal.</p>
</details>
<h2 id="paso-2-aislando-con-namespace-uts-hostname">Paso 2: Aislando con Namespace UTS (Hostname)</h2>
<p>Este <em>namespace</em> permite cambiar tanto el <em>hostname</em> como el <em>domain-name</em> del contenedor sin que afecte a estos campos del host.</p>
<p>Para lograr este aislamiento debemos <strong>añadir las siguientes líneas</strong>, además de importar el paquete necesario <a href="https://golang.org/pkg/syscall/"><code>syscall</code></a>:</p>
<div class="highlight"><pre><span></span><code><span class="nx">cmd</span><span class="p">.</span><span class="nx">SysProcAttr</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcAttr</span><span class="p">{</span>
        <span class="nx">Cloneflags</span><span class="p">:</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUTS</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div>
<p>Con estos cambios lograremos que, al iniciar el contenedor con <code>go run contenedor.go run /bin/bash</code>, <strong>podamos cambiar el <em>hostname</em> dentro del contenedor</strong> y que, al salir del mismo (saliendo del bash con un <code>exit</code>) no haya cambiado en el host.</p>
<details class="abstract"><summary>Código completo hasta ahora</summary><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;os&quot;</span>
   <span class="s">&quot;os/exec&quot;</span>
   <span class="s">&quot;syscall&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s">&quot;run&quot;</span><span class="p">:</span>
           <span class="nx">run</span><span class="p">()</span>
       <span class="k">default</span><span class="p">:</span>
            <span class="nb">panic</span><span class="p">(</span><span class="s">&quot;¿Argumento Invalido?&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">run</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Corriendo &#39;%v&#39; con User ID %d en PID %d \n&quot;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getuid</span><span class="p">(),</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">())</span>

    <span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nx">Command</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdin</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdout</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stderr</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span>

    <span class="nx">cmd</span><span class="p">.</span><span class="nx">SysProcAttr</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcAttr</span><span class="p">{</span>
        <span class="nx">Cloneflags</span><span class="p">:</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUTS</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Run</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
</details>
<h2 id="paso-3-aislando-con-namespace-user-username">Paso 3: Aislando con Namespace USER (username)</h2>
<p>Con la inclusión de este <em>namespace</em> vamos a <strong>separar las tablas de UID y GID entre el host y el contenedor</strong>, de tal forma que dentro del contenedor no haya los mismos usuarios que fuera.</p>
<p>Para crear el nuevo <em>namespace</em> simplemente es <strong>necesario añadir una <em>flag</em></strong> más al código:</p>
<div class="highlight"><pre><span></span><code><span class="nx">cmd</span><span class="p">.</span><span class="nx">SysProcAttr</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcAttr</span><span class="p">{</span>
                <span class="nx">Cloneflags</span><span class="p">:</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUTS</span> <span class="p">|</span>
                            <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUSER</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div>
<p>El problema es que ahora mismo, cuando ejecutamos el contenedor, nos informa que el proceso que lo llama tiene UID 0 pero si comprobamos el usuario que se nos asignó en la nueva tabla de UID (o sea, en la tabla del contenedor) es un usuario "aleatorio":</p>
<div class="highlight"><pre><span></span><code><span class="gp">root@bar:~$ </span>go run contenedor.go run /bin/bash
<span class="go">Corriendo &#39;[/bin/bash]&#39; con User ID 0 en PID 2792</span>
<span class="gp">root@bar:~$ </span>id
<span class="go">uid=65534(nobody) gid=65534(nogroup) groups=65534(nogroup)</span>
</code></pre></div>
<p>Así que le vamos a indicar que <strong>mapee el usuario de fuera del contenedor (UID 0) con el que queramos dentro</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="nx">cmd</span><span class="p">.</span><span class="nx">SysProcAttr</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcAttr</span><span class="p">{</span>
    <span class="nx">Cloneflags</span><span class="p">:</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUTS</span> <span class="p">|</span>
                <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUSER</span><span class="p">,</span>
    <span class="nx">UidMappings</span><span class="p">:</span> <span class="p">[]</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcIDMap</span><span class="p">{</span>
        <span class="p">{</span>
            <span class="nx">ContainerID</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>           <span class="c1">// UID dentro del contenedor</span>
            <span class="nx">HostID</span><span class="p">:</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getuid</span><span class="p">(),</span>      <span class="c1">// UID en el host</span>
            <span class="nx">Size</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>                  <span class="c1">// Quiero mapear solo un usuario</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="nx">GidMappings</span><span class="p">:</span> <span class="p">[]</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcIDMap</span><span class="p">{</span>
        <span class="p">{</span>
            <span class="nx">ContainerID</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">HostID</span><span class="p">:</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getgid</span><span class="p">(),</span>
            <span class="nx">Size</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>
</code></pre></div>
<details class="abstract"><summary>Código completo hasta ahora</summary><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;os&quot;</span>
    <span class="s">&quot;os/exec&quot;</span>
    <span class="s">&quot;syscall&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s">&quot;run&quot;</span><span class="p">:</span>
            <span class="nx">run</span><span class="p">()</span>
        <span class="k">default</span><span class="p">:</span>
            <span class="nb">panic</span><span class="p">(</span><span class="s">&quot;¿Argumento Invalido?&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">run</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Corriendo &#39;%v&#39; con User ID %d en PID %d \n&quot;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getuid</span><span class="p">(),</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">())</span>

    <span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nx">Command</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdin</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdout</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stderr</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span>

    <span class="nx">cmd</span><span class="p">.</span><span class="nx">SysProcAttr</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcAttr</span><span class="p">{</span>
        <span class="nx">Cloneflags</span><span class="p">:</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUTS</span>  <span class="p">|</span>
                    <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUSER</span><span class="p">,</span>
        <span class="nx">UidMappings</span><span class="p">:</span> <span class="p">[]</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcIDMap</span><span class="p">{</span>
            <span class="p">{</span>
                <span class="nx">ContainerID</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>             <span class="c1">// UID dentro del container</span>
                <span class="nx">HostID</span><span class="p">:</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getuid</span><span class="p">(),</span>        <span class="c1">// UID en el host</span>
                <span class="nx">Size</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>                    <span class="c1">// Quiero mapear solo unuser</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="nx">GidMappings</span><span class="p">:</span> <span class="p">[]</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcIDMap</span><span class="p">{</span>
            <span class="p">{</span>
                <span class="nx">ContainerID</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="nx">HostID</span><span class="p">:</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">(),</span>
                <span class="nx">Size</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Run</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
</details>
<h2 id="paso-4-aislando-con-namespace-ns-mount">Paso 4: Aislando con Namespace NS (Mount)</h2>
<p>Este fue el primer <em>Namespace</em> que se incluyó en el kernel de Linux y uno de los más sencillos: simplemente aisla los puntos de montaje. De esta forma podemos <strong>esconder los <em>mounts</em> entre el host y el contenedor y viceversa</strong>.</p>
<p>Para ver los puntos de montaje usados en cada una de las máquinas con el comando <code>mount</code>.</p>
<p>Para añadir esta característica debemos incluir la <em>flag</em> apropiada:</p>
<div class="highlight"><pre><span></span><code><span class="nx">cmd</span><span class="p">.</span><span class="nx">SysProcAttr</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcAttr</span><span class="p">{</span>
    <span class="nx">Cloneflags</span><span class="p">:</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUTS</span>  <span class="p">|</span>
                <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWNS</span>   <span class="p">|</span>
                <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUSER</span><span class="p">,</span>

                <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<details class="abstract"><summary>Código completo hasta ahora</summary><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;os&quot;</span>
    <span class="s">&quot;os/exec&quot;</span>
    <span class="s">&quot;syscall&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s">&quot;run&quot;</span><span class="p">:</span>
            <span class="nx">run</span><span class="p">()</span>
        <span class="k">default</span><span class="p">:</span>
            <span class="nb">panic</span><span class="p">(</span><span class="s">&quot;¿Argumento Invalido?&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">run</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Corriendo &#39;%v&#39; con User ID %d en PID %d \n&quot;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getuid</span><span class="p">(),</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">())</span>

    <span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nx">Command</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdin</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdout</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stderr</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span>

    <span class="nx">cmd</span><span class="p">.</span><span class="nx">SysProcAttr</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcAttr</span><span class="p">{</span>
        <span class="nx">Cloneflags</span><span class="p">:</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUTS</span> <span class="p">|</span>
                    <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_</span>
                    <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUSER</span><span class="p">,</span>
        <span class="nx">UidMappings</span><span class="p">:</span> <span class="p">[]</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcIDMap</span><span class="p">{</span>
            <span class="p">{</span>
                <span class="nx">ContainerID</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>             <span class="c1">// UID dentro del container</span>
                <span class="nx">HostID</span><span class="p">:</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getuid</span><span class="p">(),</span>        <span class="c1">// UID en el host</span>
                <span class="nx">Size</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>                    <span class="c1">// Quiero mapear solo unuser</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="nx">GidMappings</span><span class="p">:</span> <span class="p">[]</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcIDMap</span><span class="p">{</span>
            <span class="p">{</span>
                <span class="nx">ContainerID</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="nx">HostID</span><span class="p">:</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">(),</span>
                <span class="nx">Size</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Run</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
</details>
<h2 id="paso-5-aislando-con-namespace-pid">Paso 5: Aislando con Namespace PID</h2>
<p>El PID <em>namespace</em> permite separar los árboles de procesos, de tal forma que dentro del <strong>contenedor no se pueden ver los procesos del host</strong>.</p>
<p>Para añadir este <em>namespace</em> simplemente incluimos la <em>flag</em> apropiada:</p>
<div class="highlight"><pre><span></span><code><span class="nx">cmd</span><span class="p">.</span><span class="nx">SysProcAttr</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcAttr</span><span class="p">{</span>
    <span class="nx">Cloneflags</span><span class="p">:</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUTS</span>  <span class="p">|</span>
                <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUSER</span> <span class="p">|</span>
                <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWNS</span>   <span class="p">|</span>
                <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWPID</span><span class="p">,</span>

                <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Sin embargo, cuando ejecutamos un <code>ps a</code> seguimos pudiendo ver los mismos procesos de antes.</p>
<details class="info"><summary>Explicación: Mount Namespace no aísla los procesos</summary><p>Es importante saber que <strong><em>/proc</em></strong> es un pseudo-filesystem montado por el sistema operativo por defecto donde se muestra la información sobre los procesos. Cuando hacemos un <strong><em>ps a</em></strong>, lo que está pasando realmente es que esta instrucción está consultando los datos del directorio anteriormente nombrado.</p>
</details>
<p>La solución es asignar un nuevo <strong><em>/proc</em></strong> en la raíz del contenedor. Para ello necesitamos un nuevo <em>root filesystem</em> como Alpine (que continene únicamente los archivos necesarios para que funcione un contenedor).</p>
<h2 id="paso-6-anadiendo-un-filesystem-para-el-contenedor">Paso 6: Añadiendo un Filesystem para el contenedor</h2>
<p>Para realizar este paso necesitamos descargar el <a href="https://alpinelinux.org/downloads/">mini-root</a> de Alpine. Lo descomprimimos y lo llamamos, por ejemplo, <code>alpinefs</code> y le cambiamos el usuario con <code>chown root alpinefs/</code>.</p>
<h3 id="montamos-nuestro-propio-proc">Montamos nuestro propio /proc</h3>
<p>Necesitamos un nuevo directorio <strong><em>proc</em></strong> para que el comando <code>ps a</code> pueda acceder a él para acceder a la información de los procesos del contnedor.</p>
<details class="info"><summary>Explicación: directorio /proc</summary><p>Otra cosa que se podría intuir es que es necesario añadir el <em>Namespace NS (de Mount)</em> para aislar ambos directorios. Pero no, este último comentario es falso pese a que existan muchas referencias en la red a que es completamente necesario: cuando un proceso como <code>ps</code> quiere comprobar los procesos activos en <code>/proc</code> lo que hace es ir directamente a ese archivo. Nuestro proceso, tanto con el <em>Namespace NS</em> como sin él, va a seguir mirando los procesos en la carpeta <code>/proc</code>, es decir, la que está justo debajo del directorio raíz y no en la del nuevo <em>root filesystem</em> de alpine. Así que podríamos montar nuestro nuevo <code>proc/</code> sin el <em>Namespace NS</em>.</p>
</details>
<p>La solución de que se muestren únicamente los procesos activos de nuestro contenedor se divide en dos pasos, pero antes, debemos cambiar un poco la forma en la que habíamos planteado el programa en un principio.</p>
<p>Ahora, en vez de ejecutar desde la función <code>run</code> la instrucción indicada en los parámetros, vamos a duplicar el proceso actual llamando a <code>/proc/self/exe</code> para que en esta segunda ejecución se cambie el flujo del programa y no pase por la función <code>run</code>, sino por la función <code>child</code>.</p>
<div class="highlight"><pre><span></span><code><span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nx">Command</span> <span class="p">(</span><span class="s">&quot;/proc/self/exe&quot;</span><span class="p">,</span> <span class="nb">append</span><span class="p">([]</span><span class="kt">string</span> <span class="p">{</span><span class="s">&quot;child&quot;</span><span class="p">},</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>
<p>De esta forma, habría otra función dentro del programa que se ejecutaría la segunda vez, donde implementamos la solución a nuestro último problema:</p>
<ol>
<li>
<p>Hacer la nueva raíz de nuestro contenedor la raíz del <em>filesystem</em> que acabamos de descargar (<code>alpinefs/</code>) para que al acceder a <code>/proc</code> esté accediendo al nuevo y no al del Host. Esto se puede hacer tanto con la llamada al sistema <code>chroot</code> o <code>pivot_root</code>. La segunda opción es más segura, aunque más complicada. Por lo tanto, para evitar aumentar demasiado la complejidad se utilizará el primer método (anexando el segundo al final del tutorial).</p>
</li>
<li>
<p>Montar el <em>filesystem</em> <code>proc</code> para que el sistema pueda utilizarlo para almacenar información sobre los procesos.</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">child</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Running &#39;%v&#39; as user %d in PID %d \n&quot;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getuid</span><span class="p">(),</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">())</span>

        <span class="nx">must</span><span class="p">(</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">Chroot</span><span class="p">(</span><span class="s">&quot;alpinefs/&quot;</span><span class="p">))</span>
        <span class="nx">must</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Chdir</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">))</span>

        <span class="nx">must</span><span class="p">(</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">Mount</span><span class="p">(</span><span class="s">&quot;proc&quot;</span><span class="p">,</span> <span class="s">&quot;proc&quot;</span><span class="p">,</span> <span class="s">&quot;proc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">))</span>

        <span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nx">Command</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span>
        <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdin</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span>
        <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdout</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span>
        <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stderr</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span>

        <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">must</span><span class="p">(</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">Unmount</span><span class="p">(</span><span class="s">&quot;proc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="p">}()</span>

        <span class="nx">must</span><span class="p">(</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">Run</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></div>
<details class="info"><summary>Explicación: ¿por qué crear una nueva función?</summary><p>Ahora no sólo vamos a añadir <em>namespaces</em> y ejecutar una instrucción sino que vamos a realizar otras acciones. Si cogemos el flujo de la función <code>run</code> y realizamos las nuevas acciones después de <code>cmd.Run()</code> no se estarían completando hasta que acabara esta última orden. A su vez, si introducimos las acciones antes de <code>cmd.Run()</code> no se habrían creado aún los_namespaces: es justo mientras transcurre en <code>cmd.Run()</code> cuando queremos modificar el contenedor.</p>
<p>Por eso una opción es obligar al proceso a llamarse a una copia de sí mismo y cambiar el flujo del programa a la nueva función <code>child</code>.</p>
<p>Cabe destacar que el <em>filesystem</em> propuesto de Alpine no cuenta con Bash, así que tendríamos que mandar ejecutar <code>/bin/sh</code></p>
<p>Por otro lado, es recomendable que a partir de ahora empezemos a manejar los errores que nos puedan aparecer:</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">must</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</details>
<details class="abstract"><summary>Código completo hasta ahora</summary><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
        <span class="s">&quot;fmt&quot;</span>
        <span class="s">&quot;os&quot;</span>
        <span class="s">&quot;os/exec&quot;</span>
        <span class="s">&quot;syscall&quot;</span>
<span class="p">)</span>


<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s">&quot;run&quot;</span><span class="p">:</span>
            <span class="nx">run</span><span class="p">()</span>
        <span class="k">case</span> <span class="s">&quot;child&quot;</span><span class="p">:</span>
            <span class="nx">child</span><span class="p">()</span>
        <span class="k">default</span><span class="p">:</span>
            <span class="nb">panic</span><span class="p">(</span><span class="s">&quot;¿Argumento Invalido?&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Corriendo &#39;%v&#39; con User ID %d en PID %d \n&quot;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getuid</span><span class="p">(),</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">())</span>

        <span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nx">Command</span><span class="p">(</span><span class="s">&quot;/proc/self/exe&quot;</span><span class="p">,</span> <span class="nb">append</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;child&quot;</span><span class="p">},</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span><span class="o">...</span><span class="p">)</span>
        <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdin</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span>
        <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span>
        <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stderr</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span>

        <span class="nx">cmd</span><span class="p">.</span><span class="nx">SysProcAttr</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcAttr</span><span class="p">{</span>
                <span class="nx">Cloneflags</span><span class="p">:</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUTS</span>  <span class="p">|</span>
                            <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUSER</span> <span class="p">|</span>
                            <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWNS</span>   <span class="p">|</span>
                            <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWPID</span><span class="p">,</span>
                <span class="nx">UidMappings</span><span class="p">:</span> <span class="p">[]</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcIDMap</span><span class="p">{</span>
                        <span class="p">{</span>
                                <span class="nx">ContainerID</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="nx">HostID</span><span class="p">:</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getuid</span><span class="p">(),</span>
                                <span class="nx">Size</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="p">},</span>
                <span class="p">},</span>
                <span class="nx">GidMappings</span><span class="p">:</span> <span class="p">[]</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcIDMap</span><span class="p">{</span>
                        <span class="p">{</span>
                                <span class="nx">ContainerID</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="nx">HostID</span><span class="p">:</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getgid</span><span class="p">(),</span>
                                <span class="nx">Size</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="p">},</span>
                <span class="p">},</span>
        <span class="p">}</span>

        <span class="nx">must</span><span class="p">(</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">Run</span><span class="p">())</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">child</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Corriendo &#39;%v&#39; con User ID %d en PID %d \n&quot;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getuid</span><span class="p">(),</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">())</span>

        <span class="nx">must</span><span class="p">(</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">Sethostname</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;container&quot;</span><span class="p">)))</span>

        <span class="nx">must</span><span class="p">(</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">Chroot</span><span class="p">(</span><span class="s">&quot;alpinefs/&quot;</span><span class="p">))</span>
        <span class="nx">must</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Chdir</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">))</span>
        <span class="nx">must</span><span class="p">(</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">Mount</span><span class="p">(</span><span class="s">&quot;proc&quot;</span><span class="p">,</span> <span class="s">&quot;proc&quot;</span><span class="p">,</span> <span class="s">&quot;proc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">))</span>

        <span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nx">Command</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span>
        <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdin</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span>
        <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdout</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span>
        <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stderr</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span>

        <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">must</span><span class="p">(</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">Unmount</span><span class="p">(</span><span class="s">&quot;proc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="p">}()</span>

        <span class="nx">must</span><span class="p">(</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">Run</span><span class="p">())</span>
<span class="p">}</span>


<span class="kd">func</span> <span class="nx">must</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</details>
<details class="info"><summary>¿QUÉ HEMOS CONSEGUIDO HASTA AHORA?</summary><p>En estos momentos hemos conseguido introducir unos cuantos <em>namespaces</em>, al menos los más significativos para realizar en este tutorial.</p>
<p>El <b>hostname namespace</b> se puede comprobar de esta forma:</p>
<div class="highlight"><pre><span></span><code><span class="gp">    # </span>Fuera del contenedor
<span class="gp">root@bar:~$ </span>hostname
<span class="go">host</span>
<span class="gp">root@bar:~$ </span>go run contenedor.go run /bin/sh
<span class="go">Corriendo &#39;[/bin/sh]&#39; con User ID 0 en PID 72724</span>

<span class="gp">    # </span>Dentro del contenedor
<span class="gp">root@bar:~$ </span>sethostname contenedor
<span class="gp">root@bar:~$ </span><span class="nb">exit</span>

<span class="gp">    # </span>Fuera del contenedor
<span class="gp">root@bar:~$ </span>hostname
<span class="go">host</span>
</code></pre></div>
<p>El <b>user namespace</b> lo hemos conseguido introducir añadiendo los mapeos de usuario a root dentro del contenedor. Lo podemos comprobar de esta forma:</p>
<div class="highlight"><pre><span></span><code><span class="gp">    # </span>Fuera del contenedor
<span class="gp">root@bar:~$ </span>go run contenedor.go run /bin/sh
<span class="go">Corriendo &#39;[/bin/sh]&#39; con User ID 0 en PID 72724</span>

<span class="gp">    # </span>Dentro del contenedor
<span class="gp">root@bar:~$ </span>id
<span class="go">uid=0(root) gid=0(root) groups=0(root)</span>
</code></pre></div>
<p>El <b>mount namespace</b> se puede comprobar de una forma muy sencilla:</p>
<div class="highlight"><pre><span></span><code><span class="gp">    # </span>Fuera del contenedor
<span class="gp">root@bar:~$ </span>mount
<span class="gp">#</span><span class="c1">##### Aparecen muchos puntos de montaje usados por el host</span>
<span class="gp">root@bar:~$ </span>go run contenedor.go run /bin/sh
<span class="go">Corriendo &#39;[/bin/sh]&#39; con User ID 0 en PID 72724</span>

<span class="gp">    # </span>Dentro del contenedor
<span class="gp">root@bar:~$ </span>mount
<span class="go">proc on /proc type proc (rw,relatime)</span>
</code></pre></div>
<p>El <b>pid namespace</b> lo podemos comprobar realizando las siguientes instrucciones:</p>
<div class="highlight"><pre><span></span><code><span class="gp">    # </span>Fuera del contenedor
<span class="gp">root@bar:~$ </span>go run contenedor.go run /bin/sh
<span class="go">Corriendo &#39;[/bin/sh]&#39; con User ID 0 en PID 72724</span>

<span class="gp">    # </span>Dentro del contenedor
<span class="gp">root@bar:~$ </span>ps a
<span class="go">PID     USER    TIME   COMMAND</span>
<span class="go">    1   root     0:00  /proc/self/exe child /bin/sh</span>
<span class="go">    5   root     0:00  /bin/sh</span>
<span class="go">11   root     0:00  ps a</span>
</code></pre></div>
</details>
<h2 id="anadiendo-cgroups-memoria-y-pid">Añadiendo Cgroups (memoria y PID)</h2>
<p>En este ejemplo añadiremos un límite al número máximo de procesos en el cgroup (y, por lo tanto, en el contenedor) permitidos. Para ello necesitamos crear un nuevo directorio en <code>/sys/fs/cgroup/pids/</code>. Al crear el directorio automáticamente el sistema añade los archivos necesarios para mostrar los datos del nuevo <em>Cgroup</em> y para modificar los límites que se le quieran añadir.</p>
<p>En nuestro caso el grupo se llamará <code>demo</code>. Para modificar el número máximo de procesos que se permite en el contenedor sólo es necesario modificar el archivo donde se indica el número (pondremos como máximo 12 procesos) y otro donde se introduce al proceso del contenedor en el grupo de control.</p>
<p>Además añadiremos un número máximo de bytes de memoria que se le asignan al contenedor, aunque esto es más complicado de comprobar que funciona correctamente, pero los pasos son los mismos que en el anterior caso.</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span> <span class="nx">cg</span><span class="p">()</span>
    <span class="nx">cgroups</span> <span class="o">:=</span> <span class="s">&quot;/sys/fs/cgroup&quot;</span>
    <span class="c1">// Creando cgroup para PIDs</span>
    <span class="nx">pids</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">cgroups</span><span class="p">,</span> <span class="s">&quot;pids/demo&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stat</span><span class="p">(</span><span class="nx">pids</span><span class="p">);</span> <span class="nx">os</span><span class="p">.</span><span class="nx">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">must</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Mkdir</span><span class="p">(</span><span class="nx">pids</span><span class="p">,</span> <span class="mo">0755</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="c1">// Creando cgroup para PIDs</span>
    <span class="nx">memory</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">cgroups</span><span class="p">,</span> <span class="s">&quot;memory/demo&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stat</span><span class="p">(</span><span class="nx">memory</span><span class="p">);</span> <span class="nx">os</span><span class="p">.</span><span class="nx">IsnotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">must</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Mkdir</span><span class="p">(</span><span class="nx">memory</span><span class="p">,</span> <span class="mo">0755</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="c1">//Establecemos limite y metemos al proceso dentro del grupo de procesos</span>
    <span class="nx">must</span><span class="p">(</span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">pids</span><span class="p">,</span> <span class="s">&quot;pids.max&quot;</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;10&quot;</span><span class="p">),</span> <span class="mo">0700</span><span class="p">))</span>
    <span class="nx">must</span><span class="p">(</span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">pids</span><span class="p">,</span> <span class="s">&quot;cgroup.procs&quot;</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">())),</span> <span class="mo">0700</span><span class="p">))</span>

    <span class="nx">must</span><span class="p">(</span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">memory</span><span class="p">,</span> <span class="s">&quot;memory.limit_in_bytes&quot;</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;2M&quot;</span><span class="p">),</span> <span class="mo">0700</span><span class="p">))</span>
    <span class="nx">must</span><span class="p">(</span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">memory</span><span class="p">,</span> <span class="s">&quot;cgroup.procs&quot;</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">())),</span> <span class="mo">0700</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>
<p>Sólo hace falta llamar a esta función desde el principio de la función <code>child</code>.</p>
<h2 id="anexo-mejora-con-pivot_root">Anexo: mejora con pivot_root</h2>
<p>Cuando se introdujo en el tutorial la llamada al sistema <code>chroot</code> se mencionó la posibilidad de utilizar otra más segura: <code>pivot_root</code>.</p>
<p>Aunque antiguamente, en los primeros contenedores, se utilizaba la primera opción, se ha llegado a la conclusión de que tiene varios fallos de seguridad que permiten "salir o escapar" del contenedor. <code>pivot_root</code> aprovecha el <em>mount namespace</em> ya que permite hacer <em>unmount</em> del antiguo root y no lo hace accesible en el <em>namespace</em> del contenedor.</p>
<p>Si usamos únicamente <code>chroot</code> podemos acceder al Host con el siguiente comando: <code>chroot /proc/1/root</code>.</p>
<p>Lo que hay que saber para poder usar <code>pivot_root</code> es que necesita dos argumentos, el primero es la dirección del nuevo directorio raíz (no viene en la documentación pero debe estar montado sobre sí mismo con la opción <code>bind</code>) y el segundo es la dirección donde se va a situar el antiguo directorio raíz.</p>
<p>El código completo del tutorial quedaría así:</p>
<details class="abstract"><summary>CÓDIGO COMPLETO</summary><div class="highlight"><pre><span></span><code><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;fmt&quot;</span>
    <span class="s">&quot;os&quot;</span>
    <span class="s">&quot;os/exec&quot;</span>
    <span class="s">&quot;syscall&quot;</span>
    <span class="s">&quot;io/ioutil&quot;</span>
    <span class="s">&quot;strconv&quot;</span>
    <span class="s">&quot;path/filepath&quot;</span>
<span class="p">)</span>


<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s">&quot;run&quot;</span><span class="p">:</span>
        <span class="nx">run</span><span class="p">()</span>
    <span class="k">case</span> <span class="s">&quot;child&quot;</span><span class="p">:</span>
        <span class="nx">child</span><span class="p">()</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="nb">panic</span><span class="p">(</span><span class="s">&quot;¿Argumento Invalido?&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="kd">func</span> <span class="nx">run</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Corriendo &#39;%v&#39; con User ID %d en PID %d \n&quot;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getuid</span><span class="p">(),</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">())</span>

    <span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nx">Command</span><span class="p">(</span><span class="s">&quot;/proc/self/exe&quot;</span><span class="p">,</span> <span class="nb">append</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;child&quot;</span><span class="p">},</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span><span class="o">...</span><span class="p">)</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdin</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stderr</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span>

    <span class="nx">cmd</span><span class="p">.</span><span class="nx">SysProcAttr</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcAttr</span><span class="p">{</span>
        <span class="nx">Cloneflags</span><span class="p">:</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUTS</span>  <span class="p">|</span>
                <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWUSER</span> <span class="p">|</span>
                <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWNS</span>   <span class="p">|</span>
                <span class="nx">syscall</span><span class="p">.</span><span class="nx">CLONE_NEWPID</span><span class="p">,</span>
        <span class="nx">UidMappings</span><span class="p">:</span> <span class="p">[]</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcIDMap</span><span class="p">{</span>
            <span class="p">{</span>
                <span class="nx">ContainerID</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="nx">HostID</span><span class="p">:</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getuid</span><span class="p">(),</span>
                <span class="nx">Size</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="nx">GidMappings</span><span class="p">:</span> <span class="p">[]</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SysProcIDMap</span><span class="p">{</span>
            <span class="p">{</span>
                <span class="nx">ContainerID</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="nx">HostID</span><span class="p">:</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getgid</span><span class="p">(),</span>
                <span class="nx">Size</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nx">must</span><span class="p">(</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">Run</span><span class="p">())</span>
<span class="p">}</span>



<span class="kd">func</span> <span class="nx">child</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Corriendo &#39;%v&#39; con User ID %d en PID %d \n&quot;</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getuid</span><span class="p">(),</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">())</span>

    <span class="nx">cg</span><span class="p">()</span>

    <span class="nx">must</span><span class="p">(</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">Sethostname</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;container&quot;</span><span class="p">)))</span>

    <span class="nx">pivot</span><span class="p">()</span>
    <span class="nx">must</span><span class="p">(</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">Mount</span><span class="p">(</span><span class="s">&quot;proc&quot;</span><span class="p">,</span> <span class="s">&quot;proc&quot;</span><span class="p">,</span> <span class="s">&quot;proc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">))</span>

    <span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nx">Command</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdin</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdout</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span>
    <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stderr</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span>

    <span class="nx">must</span><span class="p">(</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">Unmount</span><span class="p">(</span><span class="s">&quot;.old_root&quot;</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">MNT_DETACH</span><span class="p">))</span>
    <span class="nx">must</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="s">&quot;.old_root&quot;</span><span class="p">))</span>

    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">must</span><span class="p">(</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">Unmount</span><span class="p">(</span><span class="s">&quot;proc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="p">}()</span>


    <span class="nx">must</span><span class="p">(</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">Run</span><span class="p">())</span>
<span class="p">}</span>


<span class="kd">func</span> <span class="nx">cg</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">cgroups</span> <span class="o">:=</span> <span class="s">&quot;/sys/fs/cgroup&quot;</span>

    <span class="nx">pids</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">cgroups</span><span class="p">,</span> <span class="s">&quot;pids/demo&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stat</span><span class="p">(</span><span class="nx">pids</span><span class="p">);</span> <span class="nx">os</span><span class="p">.</span><span class="nx">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">must</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Mkdir</span><span class="p">(</span><span class="nx">pids</span><span class="p">,</span> <span class="mo">0755</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="nx">memory</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">cgroups</span><span class="p">,</span> <span class="s">&quot;memory/demo&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stat</span><span class="p">(</span><span class="nx">memory</span><span class="p">);</span> <span class="nx">os</span><span class="p">.</span><span class="nx">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">must</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Mkdir</span><span class="p">(</span><span class="nx">memory</span><span class="p">,</span> <span class="mo">0755</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="nx">must</span><span class="p">(</span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">pids</span><span class="p">,</span> <span class="s">&quot;pids.max&quot;</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;22&quot;</span><span class="p">),</span> <span class="mo">0700</span><span class="p">))</span>
    <span class="nx">must</span><span class="p">(</span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">pids</span><span class="p">,</span> <span class="s">&quot;cgroup.procs&quot;</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">())),</span> <span class="mo">0700</span><span class="p">))</span>

    <span class="nx">must</span><span class="p">(</span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">memory</span><span class="p">,</span> <span class="s">&quot;memory.limit_in_bytes&quot;</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;2M&quot;</span><span class="p">),</span> <span class="mo">0700</span><span class="p">))</span>
    <span class="nx">must</span><span class="p">(</span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">memory</span><span class="p">,</span> <span class="s">&quot;cgroup.procs&quot;</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Getpid</span><span class="p">())),</span> <span class="mo">0700</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">pivot</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">must</span><span class="p">(</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">Mount</span><span class="p">(</span><span class="s">&quot;alpinefs&quot;</span><span class="p">,</span> <span class="s">&quot;alpinefs&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">MS_BIND</span><span class="p">|</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">MS_REC</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stat</span><span class="p">(</span><span class="s">&quot;alpinefs/.old_root&quot;</span><span class="p">);</span> <span class="nx">os</span><span class="p">.</span><span class="nx">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">must</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Mkdir</span><span class="p">(</span><span class="s">&quot;alpinefs/.old_root&quot;</span><span class="p">,</span> <span class="mo">0700</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="nx">must</span><span class="p">(</span><span class="nx">syscall</span><span class="p">.</span><span class="nx">PivotRoot</span><span class="p">(</span><span class="s">&quot;alpinefs&quot;</span><span class="p">,</span> <span class="s">&quot;alpinefs/.old_root&quot;</span><span class="p">))</span>
    <span class="nx">must</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Chdir</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">must</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</details>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../index.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: Aproximación a los contenedores" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Aproximación a los contenedores
            </div>
          </div>
        </a>
      
      
        
        <a href="contenedorbash.html" class="md-footer__link md-footer__link--next" aria-label="Next: Tutorial Bash" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Tutorial Bash
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.b0710199.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.76f349be.min.js"></script>
      
    
  </body>
</html>